function SimulationEngine(a,c,g){function h(){this.time=0;this.particle2=this.particle=null}function e(b,k){var a=new PVector(b.xVel,b.yVel),d=Math.PI/2;0!==b.xVel&&(d=Math.atan(b.yVel/b.xVel));var e=(b.xVel*Math.cos(-d)-b.yVel*Math.sin(-d))*b.cOR,f=b.x-k.x,c=b.y-k.y,l=0,l=0!==f?Math.atan(c/f):Math.atan(c/(f-1E-5));a.x=e*Math.cos(l-d);a.y=e*Math.sin(l-d);return a}this.width=a;this.height=c;var l=[];this.setBounds=function(b,k){this.width=b;this.height=k};this.reset=function(){l=[]};this.addParticle=
function(b){if(l.length<g.maxParticles)b.index=l.length,l.push(b);else throw"ERROR: Number of particles exceeds the maximum value set.";};this.removeParticle=function(b){l.splice(b,1)};this.getParticle=function(b){return l[b]};this.numOfParticles=function(){return l.length};this.edgeCollision=function(b,k){var a=b.cOR;b.x+b.radius>=this.width?k?(b.xVel*=-a,b.yVel*=a):b.x=this.width-b.radius:0>=b.x-b.radius&&(k?(b.xVel*=-a,b.yVel*=a):b.x=b.radius);b.y+b.radius>=this.height?k?(b.xVel*=a,b.yVel*=-a):
b.y=this.height-b.radius:0>=b.y-b.radius&&(k?(b.xVel*=a,b.yVel*=-a):b.y=b.radius)};this.collide=function(b,k,a){var d=k.x-b.x,e=k.y-b.y,f=k.radius+b.radius;return d*d+e*e<f*f?(d=new PVector(b.x-k.x,b.y-k.y),k=new PVector(b.xVel-k.xVel,b.yVel-k.yVel),b=k.dotProduct(k),k=-2*k.dotProduct(d),f=d.dotProduct(d)-f*f,f=k*k-4*b*f,e=d=0,0<=f&&(d=(-k-Math.sqrt(f))/(2*b),e=(-k+Math.sqrt(f))/(2*b)),a.time=0<d&&1>=d?d:0<e&&1>=e?e:1,!0):!1};this.handleCollision=function(b){var a=b.particle,n=b.particle2,d=e(a,n),
c=e(n,a),f=(d.x*(a.mass-n.mass)+2*n.mass*c.x)/(a.mass+n.mass),l=(c.x*(n.mass-a.mass)+2*a.mass*d.x)/(a.mass+n.mass),g=Math.atan((a.y-n.y)/(a.x-n.x)),h=Math.cos(g),q=Math.sin(g),g=f*h+d.y*q,d=f*q-d.y*h,f=l*h+c.y*q,c=l*q-c.y*h;this.seperateObjects(b,a,n);a.xVel=g;a.yVel=d;n.xVel=f;n.yVel=c};this.seperateObjects=function(b,a,e){b=b.time+.001*b.time;if(1>b)a.x-=a.xVel*g.speedConst*b,a.y-=a.yVel*g.speedConst*b,e.x-=e.xVel*g.speedConst*b,e.y-=e.yVel*g.speedConst*b;else{b=e.x-a.x;var d=e.y-a.y;b=e.radius-
Math.abs(Math.sqrt(b*b+d*d)-a.radius)+.1;var d=(new PVector(a.xVel,a.yVel)).getMagnitudeNS()+1E-4,c=(new PVector(e.xVel,e.yVel)).getMagnitudeNS()+1E-4,d=d/(d+c);ang=Math.atan2(a.y-e.y,a.x-e.x);a.x+=b*Math.cos(ang)*d;a.y+=b*Math.sin(ang)*d;d=1-d;e.x-=b*Math.cos(ang)*d;e.y-=b*Math.sin(ang)*d}};this.update=function(){for(var b=0;b<l.length;b++){var a=l[b];this.edgeCollision(a,!0);a.update()}for(var e=[],b=0;b<l.length;b++)for(var a=l[b],d=b+1;d<l.length;d++){var c=l[d],f=new h;this.collide(a,c,f)&&(f.particle=
a,f.particle2=c,e.push(f))}e.sort(function(b,a){return b.time<a.time});for(b=0;b<e.length;b++)f=e[b],this.handleCollision(f);for(b=0;b<l.length;b++)a=l[b],this.edgeCollision(a,!1)}};function Point2D(a,c){this.x=a;this.y=c};function PVector(a,c){this.x=a;this.y=c;this.getMagnitude=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};this.getMagnitudeNS=function(){return this.x*this.x+this.y*this.y};this.dotProduct=function(a){return this.x*a.x+this.y*a.y};this.getNormal=function(){return new PVector(-this.y,this.x)};this.rotate=function(a){var c=this.x,e=this.y;this.x=c*Math.cos(a)-e*Math.sin(a);this.y=c*Math.sin(a)+e*Math.cos(a)}};function Particle(a,c,g,h,e){PhysicsObject.call(this,a,c,10);this.radius=g;this.style=h;this.cOR=1;this.selected=!1;var l=[],b=0;this.draw=function(a,c){this.displayObj.x=a;this.displayObj.y=c;var d=this.displayObj.graphics;d.clear();if(this.selected){for(var g=l.length,f=1;f<g;f++){var h=l[(f+b)%g],t=h.x-a,h=h.y-c;d.beginStroke("rgba(100, 100, 100, "+f/g+")").drawCircle(t,h,this.radius).endStroke()}d.beginStroke("red").setStrokeStyle(3).drawCircle(0,0,this.radius).endStroke()}d.beginFill(this.style).drawCircle(0,
0,this.radius).endFill();(this.selected||e.showVelocities)&&d.beginStroke("red").setStrokeStyle(3).moveTo(0,0).lineTo(this.xVel*e.updateRate,this.yVel*e.updateRate).endStroke()};this.select=function(){this.selected=!0};this.deselect=function(){this.selected=!1;l=[]};this.update=function(){this.x+=this.xVel*e.speedConst;this.y+=this.yVel*e.speedConst;var a=l.length;this.selected&&(b++,b%=e.maxTraceLength,a<e.maxTraceLength?l.push(new Point2D(this.x,this.y)):l[b]=new Point2D(this.x,this.y))};this.copy=
function(){var a=new Particle(this.x,this.y,this.radius,this.style,e);a.index=this.index;a.cOR=this.cOR;a.mass=this.mass;a.xVel=this.xVel;a.yVel=this.yVel;return a}}Particle.prototype=new PhysicsObject;function PhysicsObject(a,c,g){this.x=a;this.y=c;this.lastX=this.x;this.lastY=this.y;this.yVel=this.xVel=0;this.mass=g;this.displayObj=new createjs.Shape;this.displayObj.x=this.x;this.displayObj.y=this.y;this.capture=function(){this.lastX=this.x;this.lastY=this.y};this.update=function(){this.x+=this.xVel*speedConst;this.y+=this.yVel*speedConst};this.addEventHandler=function(a,e){this.displayObj.addEventListener(a,e)};this.getEnergy=function(){return.5*this.mass*(this.xVel*this.xVel+this.yVel*this.yVel)};
this.draw=function(a,e){this.displayObj.x=a;this.displayObj.y=e}};function Graph(a,c,g,h,e){Widget.call(this,a);this.scaleX=g;this.scaleY=h;this.y=this.x=0;this.engine=c;var l=new createjs.Shape,b=0,k=0,n=0,d=[],p=0,f=150,u=!1,t=0,v=0,q=0;this.init=function(){var a=new createjs.Shape,b=new createjs.Shape;a.graphics.beginStroke("red").moveTo(this.x,this.height).lineTo(this.width,this.height);b.graphics.beginStroke("red").moveTo(this.x,this.y).lineTo(this.x,this.height);this.stage.addChild(a);this.stage.addChild(b);this.stage.addChild(l);this.updateData()};this.draw=
function(a){if(null!=this.engine){a=l.graphics;a.clear();for(var f=d.length-1,c=0,g=0;g<f-1;g++){if(u){u=!1;return}var c=c+d[g].y,h=(p+g)%f,x=(p+g+1)%f,y=d[h].x*this.scaleX-b;y>this.width&&(b+=y-this.width);var y=d[h].x*this.scaleX-b,h=d[h].y*this.scaleY+k+n,q=d[x].x*this.scaleX-b,x=d[x].y*this.scaleY+k+n;a.beginStroke("red").moveTo(this.x+y,this.y+this.height-h).lineTo(this.x+q,this.y+this.height-x)}this.paused||(t+=1E3/e.updateRate,v=this.getEnergy(),this.addData(t,v));k=this.height/2-c/d.length*
this.scaleY;this.stage.update()}};this.restart=function(){d=[];b=k=t=v=p=0;u=!0};this.calibrate=function(){n=0};this.zoomIn=function(){if(q<e.graphMaxZoomIndex)this.scaleX*=e.graphZoomFactor,this.scaleY*=e.graphZoomFactor,b*=this.scaleX,k*=this.scaleY,this.updateData(),q++;else throw"ERROR: Maximum zoom reached";};this.zoomOut=function(){if(q>-e.graphMinZoomIndex)this.scaleX/=e.graphZoomFactor,this.scaleY/=e.graphZoomFactor,b*=this.scaleX,k*=this.scaleY,this.updateData(),q--;else throw"ERROR: Minimum zoom reached";
};this.moveUp=function(){n-=5};this.moveDown=function(){n+=5};this.addData=function(a,b){if(d.length>f){var e=p;p=(p+1)%f;d[e]=new Point2D(a,b)}else d.push(new Point2D(a,b))};this.updateData=function(){var a=[];f=Math.round(this.width/(1E3/e.updateRate*this.scaleX))+5;var b=d.length-1,c=0;for(b>f&&(c=b-f);c<b;c++)a.push(d[(p+c)%b]);u=!0;p=0;d=a};this.getEnergy=function(){for(var a=0,b=0;b<this.engine.numOfParticles();b++)a+=this.engine.getParticle(b).getEnergy();return Math.round(a/1E3)}}
Graph.prototype=new Widget;function Overlay(a,c,g){function h(a,b){return b?h(b,a%b):a}Widget.call(this,a);this.hide();var e=0,l=-1,b=crossX=this.width/2,k=crossY=this.height/2,n=new createjs.Shape,d=new createjs.Text("","bold 15px Arial"),p=new createjs.Text("","bold 15px Arial","red"),f=0,u=!1,t=new createjs.Text("","bold 15px Arial");t.x=this.width/2-40;t.y=10;var v=!1,q=!1,z=0,A=0,m=null,w=h(this.width,this.height),r=this;this.canvas.mousewheel(function(a){0>a.deltaY?m.radius>g.minRadius&&--m.radius:m.radius<g.maxRadius&&
(m.radius+=1)});this.resize=function(a,b){w=h(this.width,this.height)};$(document).keydown(function(a){v=a.ctrlKey;q=a.shiftKey});$(document).keyup(function(a){q=v=!1});this.canvas.bind("contextmenu",function(a){return!1});this.init=function(){this.stage.removeAllChildren();b=crossX=this.width/2;k=crossY=this.height/2;this.stage.addChild(t)};this.stage.addEventListener("stagemousemove",function(a){b=crossX=a.stageX;k=crossY=a.stageY;if(!v){a=Math.round(b/w);var f=Math.round(k/w);crossX=a*w;crossY=
f*w}switch(e){case 0:n.x=crossX;n.y=crossY;null!=m&&(m.x=crossX,m.y=crossY);d.x=crossX-50;d.y=crossY-50;break;case 1:var l=n.graphics;a=crossX-n.x;f=crossY-n.y;d.x=n.x+a/2;d.y=n.y+f/2;d.text=Math.round(Math.sqrt(a*a+f*f))+" px/s";m.xVel=a/g.updateRate;m.yVel=f/g.updateRate;l.clear().beginStroke("red").setStrokeStyle(3).moveTo(0,0).lineTo(a,f);break;case 2:for(l=0;l<c.engine.numOfParticles();l++){var h=c.engine.getParticle(l);a=h.x-b;f=h.y-k;a*a+f*f<=h.radius*h.radius?(h.select(),m=h):h.deselect()}}});
this.canvas.mousedown(function(a){if(2==a.button&&2!=e){switch(e){case 0:r.end()}console.log("SDFSD");if(1==l){var b=c.addParticle(z,A,m.mass,m.radius,m.style);b.xVel=m.xVel;b.yVel=m.yVel;r.removeChild(m.displayObj);m=null;e=2}else r.stage.removeChild(n),r.stage.removeChild(d),e=0}else switch(e){case 0:n.graphics.clear();r.stage.addChild(n);r.stage.addChild(d);e=1;break;case 1:try{b=c.addParticle(m.x,m.y,m.mass,m.radius,m.style),b.xVel=m.xVel,b.yVel=m.yVel,b.cOR=m.cOR,r.stage.removeChild(n),r.stage.removeChild(d),
m.xVel=m.yVel=0,1!=l||q?e=0:(e=2,r.stage.removeChild(m.displayObj))}catch(k){p.text=k,p.x=r.width-p.getMeasuredWidth(),p.y=r.height/2,r.stage.addChild(p),f=g.errorTime,u=!0}break;case 2:m.displayObj.dispatchEvent("click"),2==a.button?c.removeSelected():(b=m,m=b.copy(),z=b.x,A=b.y,r.stage.addChild(m.displayObj),q||c.removeSelected(),e=0)}a.stopPropagation()});this.draw=function(a){this.hidden||(null!=m&&m.draw(m.x,m.y),u&&(f-=1E3/g.updateRate,0>=f&&(u=!1,this.stage.removeChild(p))),this.stage.update())};
this.beginAdd=function(a,f,c){this.show();this.init();m=new Particle(crossX,crossY,25,c,g);m.mass=a;m.cOR=f;d.x=b;d.y=k;this.stage.addChild(m.displayObj);t.text="Mode: Add";l=e=0};this.beginEdit=function(){this.show();this.init();t.text="Mode: Edit";e=2;l=1};this.end=function(){this.hide();this.stage.removeAllChildren();null!=m&&(m=null);l=-1;q=v=!1};this.getCurrentParticle=function(){return m};this.getMode=function(){return l}}Overlay.prototype=new Widget;function Simulation(a,c,g){Widget.call(this,a);this.engine=c;this.engine.width=this.width;this.engine.height=this.height;var h=-1;this.resize=function(a,c){this.engine.setBounds(a,c)};this.addParticle=function(a,c,b,k,n){a=new Particle(a,c,k,n,g);a.mass=b;var d=this.engine;a.addEventHandler("click",function(a){var b=d.getParticle(h);-1!=h&&b.deselect();for(b=0;b<d.numOfParticles();b++)if(d.getParticle(b).displayObj==a.target){b!=h?(h=b,d.getParticle(b).selected=!0):h=-1;break}});this.stage.addChild(a.displayObj);
this.engine.addParticle(a);return a};this.removeParticle=function(a){this.stage.removeChild(this.engine.getParticle(a).displayObj);this.engine.removeParticle(a)};this.loadParticles=function(a){this.restart();for(var c=0;c<a.length;c++){var b=a[c],g=this.addParticle(b.x,b.y,b.mass,b.radius,b.style);g.xVel=b.xVel;g.yVel=b.yVel;g.cOR=b.cOR}};this.saveParticles=function(a){for(var c=0;c<this.engine.numOfParticles();c++){var b=this.engine.getParticle(c);a.push(b.copy())}};this.removeSelected=function(){-1!=
h&&(this.removeParticle(h),h=-1)};this.getSelected=function(){var a=null;-1!=h&&(a=this.engine.getParticle(h));return a};this.getSelectedID=function(){return h};this.restart=function(){this.stage.removeAllChildren();h=-1;this.engine.reset()};this.draw=function(a){for(var c=0;c<this.engine.numOfParticles();c++){var b=this.engine.getParticle(c),k=b.x,h=b.y;g.enableInterpolation&&(h=b.y-b.lastY,k=b.lastX+a*(b.x-b.lastX),h=b.lastY+a*h);b.draw(k,h)}this.stage.update()}}Simulation.prototype=new Widget;function Widget(a){this.hidden=!1;this.canvasName=a;this.canvas=$("#"+a);this.width=this.canvas.width();this.height=this.canvas.height();this.stage=new createjs.Stage(a);this.canvas.attr("width",this.width);this.canvas.attr("height",this.height);this.init=function(){};this.addEventListener=function(a,g){this.stage.addEventListener(a,g)};this.draw=function(a){};this.restart=function(){};this.stop=function(){};this.resume=function(){this.paused=!1};this.pause=function(){this.paused=!0};this.resize=
function(a,g){};this.show=function(){this.hidden=!1;this.canvas.fadeIn(200)};this.hide=function(){this.hidden=!0;this.canvas.fadeOut(200)}};function ECollision(a){this.settings=a;this.paused=!1;this.engine=new SimulationEngine(a.simulationWidth,a.simulationHeight,this.settings);this.simulationUI=new Simulation(a.simulationCanvas,this.engine,this.settings);this.graphUI=new Graph(a.graphCanvas,this.engine,.02,5,this.settings);this.overlayUI=new Overlay(a.overlayCanvas,this.simulationUI,this.settings);this.fps=0;var c=[this.simulationUI,this.graphUI,this.overlayUI],g=0,h=0,e=timeStamp=curTime=0,l=a.updateRate,b=1E3/l,k=1E3/a.refreshRate,
n=0,d=-1,p=this;this.start=function(){for(var b=0;b<c.length;b++)c[b].init();d=setInterval(this.tick,1E3/a.refreshRate)};this.restart=function(){for(var a=0;a<c.length;a++)c[a].restart()};this.resume=function(){this.paused=!1;for(var a=0;a<c.length;a++)c[a].resume()};this.pause=function(){this.paused=!0;for(var a=0;a<c.length;a++)c[a].pause()};this.stop=function(){-1!=d&&(clearInterval(d),d=-1)};this.getUpdateRate=function(){return l};this.getUpdateTime=function(){return b};this.setUpdateRate=function(a){l=
a;b=1E3/l};this.setSpeedConst=function(a){this.engine.speedConst=a};this.onTick=function(){};this.update=function(){curTime+=k;if(e+b<curTime){timeStamp=curTime;if(a.enableInterpolation)for(var c=0;c<this.engine.numOfParticles();c++)this.engine.getParticle(c).capture();for(;e+b<curTime;)this.engine.update(),e+=b}n=Math.min(1,(curTime-timeStamp)/b)};this.tick=function(){p.paused||p.update();var a=(new Date).getTime();g++;1E3<=a-h&&(p.fps=g,g=0,h=a);for(a=0;a<c.length;a++)c[a].draw(n);p.onTick()}};var eCollisionSettings={simulationWidth:1E3,simulationHeight:1E3,simulationCanvas:"simulation-canvas",graphCanvas:"graph-canvas",overlayCanvas:"overlay-canvas",refreshRate:60,updateRate:60,showVelocities:!1,enableInterpolation:!0,maxTraceLength:30,graphScaleX:.02,graphScaleY:5,graphZoomFactor:1.25,graphMinZoomIndex:5,graphMaxZoomIndex:5,speedConst:1,maxParticles:20,minRadius:5,maxRadius:30,errorTime:5E3};$.widget("custom.sliderEx",$.ui.slider,{_unit:"",_amount:null,_formatVal:function(a){.09<a&&1>a&&(a=a.toPrecision(2));return a+" "+this._unit},_slide:function(){this._superApply(arguments);this._amount.text(this._formatVal(this.options.value));var a=this.handle.position();this._amount.width();this._amount.css("left",a.left+"px")},_start:function(){this._superApply(arguments);var a=this.handle.css("left");this._amount.css("visibility","visible").hide().fadeIn("fast").css("left",a)},_stop:function(){this._superApply(arguments);
this._amount.fadeOut("fast")},_create:function(){var a=parseFloat(this.element.attr("min")),c=parseFloat(this.element.attr("max"));this.options.min=a;this.options.max=c;this.options.step=parseFloat(this.element.attr("step"))||1;this.options.value=parseFloat(this.element.attr("value"))||a+c/2;this._unit=this.element.attr("unit")||"";this._amount=$('<div class="slider-amount">'+this._formatVal(this.options.value)+"</div>");this.element.append(this._amount).mousedown(function(a){a.stopPropagation()});
this._super()}});function getRandomColor(){for(var a="0123456789ABCDEF".split(""),c="#",g=0;6>g;g++)c+=a[Math.floor(16*Math.random())];return c}function toDegrees(a){a=a/Math.PI*180+90;0>a?a+=360:360<a&&(a-=360);return a}function setCol(a,c){return(""+a).fontcolor(c)}function setColGreen(a){return setCol(a,"green")}function dbgBool(a){return a?setCol(""+a,"green"):setCol(""+a,"red")}function log(a){console.log(a)}
$("#slider-mass").sliderEx({slide:function(a,c){var g=ecollision.overlayUI.getCurrentParticle()||ecollision.simulationUI.getSelected();null!=g&&(g.mass=c.value)}});$("#slider-cor").sliderEx({slide:function(a,c){var g=ecollision.overlayUI.getCurrentParticle()||ecollision.simulationUI.getSelected();null!=g&&(g.cOR=c.value)}});
function openAdd(){if(0==ecollision.overlayUI.getMode())ecollision.overlayUI.end();else{var a=$("#slider-mass").sliderEx("value"),c=$("#slider-cor").sliderEx("value");ecollision.overlayUI.beginAdd(a,c,currentColor)}}function openEdit(){1==ecollision.overlayUI.getMode()?ecollision.overlayUI.end():ecollision.overlayUI.beginEdit()}$(document).keypress(function(a){97==a.charCode?openAdd():101==a.charCode&&openEdit()});$("#add-particle").click(function(){openAdd()});$("#remove-particle").click(function(){openEdit()});
var currentColor=getRandomColor();$("#generate-colour").click(function(){var a=ecollision.overlayUI.getCurrentParticle()||ecollision.simulationUI.getSelected();null!=a&&(currentColor=getRandomColor(),a.style=currentColor)});$("#calibrate").click(function(){ecollision.graphUI.calibrate()});$("#zoom-in").click(function(){ecollision.graphUI.zoomIn()});$("#zoom-out").click(function(){ecollision.graphUI.zoomOut()});$("#move-up").click(function(){ecollision.graphUI.moveUp()});$("#move-down").click(function(){ecollision.graphUI.moveDown()});
$("#btn-sim-data").click(function(){eCollisionSettings.showVelocities=!eCollisionSettings.showVelocities});$("#btn-run-pause").click(function(){ecollision.paused?ecollision.resume():ecollision.pause();changeRunPauseBtn()});function changeRunPauseBtn(){ecollision.paused?$("#btn-run-pause").removeClass("icon-pause").addClass("icon-playback-play").text("RUN"):$("#btn-run-pause").removeClass("icon-playback-play").addClass("icon-pause").text("PAUSE")}$("#btn-next").click(function(){ecollision.update()});
var savedState=[];$("#btn-save").click(function(){savedState=[];ecollision.simulationUI.saveParticles(savedState)});$("#btn-load").click(function(){ecollision.simulationUI.loadParticles(savedState)});$("#btn-reset").click(function(){ecollision.restart()});$("#sim-speed-slider").sliderEx({slide:function(a,c){eCollisionSettings.speedConst=parseFloat(c.value)}});var ecollision=new ECollision(eCollisionSettings),fpsDiv=$("#fps-div"),particleInfo=$("#particle-info-box");
ecollision.onTick=function(){(new Date).getTime();if(eCollisionSettings.showVelocities){var a="",a=24>ecollision.fps?setCol(ecollision.fps,"red"):setCol(ecollision.fps,"green");debugStr="Frame rate: "+a+" Hz<br /> Update rate: "+setColGreen(ecollision.getUpdateRate())+" Hz<br /> Energy in system: "+setColGreen(ecollision.graphUI.getEnergy())+" kJ<br /> Number of particles: "+setColGreen(ecollision.engine.numOfParticles());fpsDiv.html(debugStr)}else fpsDiv.html("");a=ecollision.simulationUI.getSelected();
if(null!=a){var c="<b>XVel:</b> "+Math.round(a.xVel*eCollisionSettings.updateRate)+" px/s<br /> <b>YVel:</b> "+Math.round(a.yVel*eCollisionSettings.updateRate)+" px/s<br /> <b>Direction:</b> "+Math.round(toDegrees(Math.atan2(a.yVel,a.xVel)))+" degrees<br /> <b>Mass:</b> "+a.mass+" kg<br /> <b>CoR:</b> "+a.cOR+"<br /> <b>Radius:</b> "+a.radius+" px";"<br /> <b>Energy:</b> "+Math.round(a.getEnergy())+" J";particleInfo.html(c)}else particleInfo.html("")};ecollision.start();