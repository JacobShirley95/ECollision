function ECollision(k){this.settings=k;this.paused=!1;this.engine=new SimulationEngine(k.simulation.simulationWidth,k.simulation.simulationHeight,this.settings);this.simulationUI=new Simulation(k.simulation.simulationCanvas,this.engine,this.settings);this.graphUI=new Graph(k.graph.graphCanvas,this.engine,0.02,5,this.settings);this.overlayUI=new Overlay(k.overlay.overlayCanvas,this.simulationUI,this.settings);this.fps=0;var g=[this.simulationUI,this.graphUI,this.overlayUI],m=0,h=0,c=timeStamp=curTime=
0,d=k.global.updateRate,a=1E3/d,b=1E3/k.global.refreshRate,f=0,e=-1,n=this;this.start=function(){for(var a=0;a<g.length;a++)g[a].init();e=setInterval(this.tick,1E3/k.global.refreshRate)};this.restart=function(){for(var a=0;a<g.length;a++)g[a].restart()};this.resume=function(){this.paused=!1;for(var a=0;a<g.length;a++)g[a].resume()};this.pause=function(){this.paused=!0;for(var a=0;a<g.length;a++)g[a].pause()};this.stop=function(){-1!=e&&(clearInterval(e),e=-1)};this.getUpdateRate=function(){return d};
this.getUpdateTime=function(){return a};this.setUpdateRate=function(b){d=b;a=1E3/d};this.setSpeedConst=function(a){this.engine.speedConst=a};this.onTick=function(){};this.update=function(){curTime+=b;if(c+a<curTime){timeStamp=curTime;if(k.global.enableInterpolation)for(var e=0;e<this.engine.numOfParticles();e++)this.engine.getParticle(e).capture();for(;c+a<curTime;)this.engine.update(),c+=a}f=Math.min(1,(curTime-timeStamp)/a)};this.tick=function(){n.paused||n.update();var a=(new Date).getTime();m++;
1E3<=a-h&&(n.fps=m,m=0,h=a);for(a=0;a<g.length;a++)g[a].draw(f);n.onTick()}};function SimulationEngine(k,g,m){function h(){this.time=0;this.particle2=this.particle=null}function c(a,b){var f=new PVector(a.xVel,a.yVel),e=Math.PI/2;0!==a.xVel&&(e=Math.atan(a.yVel/a.xVel));var c=(a.xVel*Math.cos(-e)-a.yVel*Math.sin(-e))*a.cOR,d=a.x-b.x,m=a.y-b.y,g=0,g=0!==d?Math.atan(m/d):Math.atan(m/(d-1E-5));f.x=c*Math.cos(g-e);f.y=c*Math.sin(g-e);return f}this.width=k;this.height=g;var d=[];this.setBounds=function(a,b){this.width=a;this.height=b};this.reset=function(){d=[]};this.addParticle=
function(a){if(d.length<m.global.maxParticles)a.index=d.length,d.push(a);else throw"ERROR: Number of particles exceeds the maximum value set.";};this.removeParticle=function(a){d.splice(a,1)};this.getParticle=function(a){return d[a]};this.numOfParticles=function(){return d.length};this.edgeCollision=function(a,b){var f=a.cOR;a.x+a.radius>=this.width?b?(a.xVel*=-f,a.yVel*=f):a.x=this.width-a.radius:0>=a.x-a.radius&&(b?(a.xVel*=-f,a.yVel*=f):a.x=a.radius);a.y+a.radius>=this.height?b?(a.xVel*=f,a.yVel*=
-f):a.y=this.height-a.radius:0>=a.y-a.radius&&(b?(a.xVel*=f,a.yVel*=-f):a.y=a.radius)};this.collide=function(a,b,f){var e=b.x-a.x,c=b.y-a.y,d=b.radius+a.radius;return e*e+c*c<d*d?(e=new PVector(a.x-b.x,a.y-b.y),b=new PVector(a.xVel-b.xVel,a.yVel-b.yVel),a=b.dotProduct(b),b=-2*b.dotProduct(e),d=e.dotProduct(e)-d*d,d=b*b-4*a*d,c=e=0,0<=d&&(e=(-b-Math.sqrt(d))/(2*a),c=(-b+Math.sqrt(d))/(2*a)),f.time=0<e&&1>=e?e:0<c&&1>=c?c:1,!0):!1};this.handleCollision=function(a){var b=a.particle,f=a.particle2,e=c(b,
f),d=c(f,b),m=(e.x*(b.mass-f.mass)+2*f.mass*d.x)/(b.mass+f.mass),g=(d.x*(f.mass-b.mass)+2*b.mass*e.x)/(b.mass+f.mass),h=Math.atan((b.y-f.y)/(b.x-f.x)),k=Math.cos(h),p=Math.sin(h),h=m*k+e.y*p,e=m*p-e.y*k,m=g*k+d.y*p,d=g*p-d.y*k;this.seperateObjects(a,b,f);b.xVel=h;b.yVel=e;f.xVel=m;f.yVel=d};this.seperateObjects=function(a,b,f){a=a.time+0.001*a.time;if(1>a)b.x-=b.xVel*m.global.speedConst*a,b.y-=b.yVel*m.global.speedConst*a,f.x-=f.xVel*m.global.speedConst*a,f.y-=f.yVel*m.global.speedConst*a;else{a=
f.x-b.x;var e=f.y-b.y;a=f.radius-Math.abs(Math.sqrt(a*a+e*e)-b.radius)+0.1;var e=(new PVector(b.xVel,b.yVel)).getMagnitudeNS()+1E-4,c=(new PVector(f.xVel,f.yVel)).getMagnitudeNS()+1E-4,e=e/(e+c);ang=Math.atan2(b.y-f.y,b.x-f.x);b.x+=a*Math.cos(ang)*e;b.y+=a*Math.sin(ang)*e;e=1-e;f.x-=a*Math.cos(ang)*e;f.y-=a*Math.sin(ang)*e}};this.update=function(){for(var a=0;a<d.length;a++){var b=d[a];this.edgeCollision(b,!0);b.update()}for(var c=[],a=0;a<d.length;a++)for(var b=d[a],e=a+1;e<d.length;e++){var m=d[e],
g=new h;this.collide(b,m,g)&&(g.particle=b,g.particle2=m,c.push(g))}c.sort(function(a,b){return a.time<b.time});for(a=0;a<c.length;a++)g=c[a],this.handleCollision(g);for(a=0;a<d.length;a++)b=d[a],this.edgeCollision(b,!1)}};function Point2D(k,g){this.x=k;this.y=g};function PVector(k,g){this.x=k;this.y=g;this.getMagnitude=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};this.getMagnitudeNS=function(){return this.x*this.x+this.y*this.y};this.dotProduct=function(g){return this.x*g.x+this.y*g.y};this.getNormal=function(){return new PVector(-this.y,this.x)};this.rotate=function(g){var h=this.x,c=this.y;this.x=h*Math.cos(g)-c*Math.sin(g);this.y=h*Math.sin(g)+c*Math.cos(g)}};function Particle(k,g,m,h,c){PhysicsObject.call(this,k,g,10);this.radius=m;this.style=h;this.cOR=1;this.selected=!1;var d=[],a=0;this.draw=function(b,f){this.displayObj.x=b;this.displayObj.y=f;var e=this.displayObj.graphics;e.clear();if(this.selected){for(var g=d.length,m=1;m<g;m++){var h=d[(m+a)%g],k=h.x-b,h=h.y-f;e.beginStroke("rgba(100, 100, 100, "+m/g+")").drawCircle(k,h,this.radius).endStroke()}e.beginStroke("red").setStrokeStyle(3).drawCircle(0,0,this.radius).endStroke()}e.beginFill(this.style).drawCircle(0,
0,this.radius).endFill();(this.selected||c.global.showVelocities)&&e.beginStroke("red").setStrokeStyle(3).moveTo(0,0).lineTo(this.xVel*c.global.updateRate,this.yVel*c.global.updateRate).endStroke()};this.select=function(){this.selected=!0};this.deselect=function(){this.selected=!1;d=[]};this.update=function(){this.x+=this.xVel*c.global.speedConst;this.y+=this.yVel*c.global.speedConst;var b=d.length;this.selected&&(a++,a%=c.global.maxTraceLength,b<c.global.maxTraceLength?d.push(new Point2D(this.x,
this.y)):d[a]=new Point2D(this.x,this.y))};this.copy=function(){var a=new Particle(this.x,this.y,this.radius,this.style,c);a.index=this.index;a.cOR=this.cOR;a.mass=this.mass;a.xVel=this.xVel;a.yVel=this.yVel;return a}}Particle.prototype=new PhysicsObject;function PhysicsObject(k,g,m){this.x=k;this.y=g;this.lastX=this.x;this.lastY=this.y;this.yVel=this.xVel=0;this.mass=m;this.displayObj=new createjs.Shape;this.displayObj.x=this.x;this.displayObj.y=this.y;this.capture=function(){this.lastX=this.x;this.lastY=this.y};this.update=function(){this.x+=this.xVel*speedConst;this.y+=this.yVel*speedConst};this.addEventHandler=function(g,c){this.displayObj.addEventListener(g,c)};this.getEnergy=function(){return 0.5*this.mass*(this.xVel*this.xVel+this.yVel*this.yVel)};
this.draw=function(g,c){this.displayObj.x=g;this.displayObj.y=c}};function ECollisionSettings(){this.global={refreshRate:60,updateRate:60,showVelocities:!1,enableInterpolation:!0,maxTraceLength:30,speedConst:1,maxParticles:20,minRadius:5,maxRadius:30,errorTime:5E3};this.simulation={simulationWidth:1E3,simulationHeight:1E3,simulationCanvas:"simulation-canvas"};this.graph={graphCanvas:"graph-canvas",graphScaleX:0.02,graphScaleY:5,graphZoomFactor:1.25,graphMinZoomIndex:5,graphMaxZoomIndex:5};this.overlay={overlayCanvas:"overlay-canvas"}};function Graph(k,g,m,h,c){Widget.call(this,k);this.scaleX=m;this.scaleY=h;this.y=this.x=0;this.engine=g;var d=new createjs.Shape,a=0,b=0,f=0,e=[],n=0,r=150,t=!1,s=0,u=0,p=0;this.init=function(){var a=new createjs.Shape,b=new createjs.Shape;a.graphics.beginStroke("red").moveTo(this.x,this.height).lineTo(this.width,this.height);b.graphics.beginStroke("red").moveTo(this.x,this.y).lineTo(this.x,this.height);this.stage.addChild(a);this.stage.addChild(b);this.stage.addChild(d);this.updateData()};this.draw=
function(g){if(null!=this.engine){g=d.graphics;g.clear();for(var m=e.length-1,l=0,h=0;h<m-1;h++){if(t){t=!1;return}var l=l+e[h].y,k=(n+h)%m,w=(n+h+1)%m,x=e[k].x*this.scaleX-a;x>this.width&&(a+=x-this.width);var x=e[k].x*this.scaleX-a,k=e[k].y*this.scaleY+b+f,p=e[w].x*this.scaleX-a,w=e[w].y*this.scaleY+b+f;g.beginStroke("red").moveTo(this.x+x,this.y+this.height-k).lineTo(this.x+p,this.y+this.height-w)}this.paused||(s+=1E3/c.global.updateRate,u=this.getEnergy(),this.addData(s,u));b=this.height/2-l/
e.length*this.scaleY;this.stage.update()}};this.restart=function(){e=[];a=b=s=u=n=0;t=!0};this.calibrate=function(){f=0};this.zoomIn=function(){if(p<c.graph.graphMaxZoomIndex)this.scaleX*=c.graph.graphZoomFactor,this.scaleY*=c.graph.graphZoomFactor,a*=this.scaleX,b*=this.scaleY,this.updateData(),p++;else throw"ERROR: Maximum zoom reached";};this.zoomOut=function(){if(p>-c.graph.graphMinZoomIndex)this.scaleX/=c.graph.graphZoomFactor,this.scaleY/=c.graph.graphZoomFactor,a*=this.scaleX,b*=this.scaleY,
this.updateData(),p--;else throw"ERROR: Minimum zoom reached";};this.moveUp=function(){f-=5};this.moveDown=function(){f+=5};this.addData=function(a,b){if(e.length>r){var c=n;n=(n+1)%r;e[c]=new Point2D(a,b)}else e.push(new Point2D(a,b))};this.updateData=function(){var a=[];r=Math.round(this.width/(1E3/c.global.updateRate*this.scaleX))+5;var b=e.length-1,f=0;for(b>r&&(f=b-r);f<b;f++)a.push(e[(n+f)%b]);t=!0;n=0;e=a};this.getEnergy=function(){for(var a=0,b=0;b<this.engine.numOfParticles();b++)a+=this.engine.getParticle(b).getEnergy();
return Math.round(a/1E3)}}Graph.prototype=new Widget;function Overlay(k,g,m){function h(a,b){return b?h(b,a%b):a}Widget.call(this,k);this.hide();var c=0,d=-1,a=crossX=this.width/2,b=crossY=this.height/2,f=new createjs.Shape,e=new createjs.Text("","bold 15px Arial"),n=new createjs.Text("","bold 15px Arial","red"),r=0,t=!1,s=new createjs.Text("","bold 15px Arial");s.x=this.width/2-40;s.y=10;var u=!1,p=!1,y=0,z=0,l=null,v=h(this.width,this.height),q=this;this.canvas.mousewheel(function(a){0>a.deltaY?l.radius>m.global.minRadius&&(l.radius-=1):l.radius<
m.global.maxRadius&&(l.radius+=1)});this.resize=function(a,b){v=h(this.width,this.height)};$(document).keydown(function(a){u=a.ctrlKey;p=a.shiftKey});$(document).keyup(function(a){p=u=!1});this.canvas.bind("contextmenu",function(a){return!1});this.init=function(){this.stage.removeAllChildren();a=crossX=this.width/2;b=crossY=this.height/2;this.stage.addChild(s)};this.stage.addEventListener("stagemousemove",function(d){a=crossX=d.stageX;b=crossY=d.stageY;if(!u){d=Math.round(a/v);var h=Math.round(b/
v);crossX=d*v;crossY=h*v}switch(c){case 0:f.x=crossX;f.y=crossY;null!=l&&(l.x=crossX,l.y=crossY);e.x=crossX;e.y=crossY;break;case 1:var k=f.graphics;d=crossX-f.x;h=crossY-f.y;e.x=f.x+d/2;e.y=f.y+h/2;e.text=Math.round(Math.sqrt(d*d+h*h))+" px/s";l.xVel=d/m.global.updateRate;l.yVel=h/m.global.updateRate;k.clear().beginStroke("red").setStrokeStyle(3).moveTo(0,0).lineTo(d,h);break;case 2:for(k=0;k<g.engine.numOfParticles();k++){var n=g.engine.getParticle(k);d=n.x-a;h=n.y-b;d*d+h*h<=n.radius*n.radius?
(n.select(),l=n):n.deselect()}}});this.canvas.mousedown(function(a){if(2==a.button&&2!=c){switch(c){case 0:q.end()}if(1==d){var b=g.addParticle(y,z,l.mass,l.radius,l.style);b.xVel=l.xVel;b.yVel=l.yVel;q.removeChild(l.displayObj);l=null;c=2}else q.stage.removeChild(f),q.stage.removeChild(e),c=0}else switch(c){case 0:f.graphics.clear();q.stage.addChild(f);q.stage.addChild(e);c=1;break;case 1:try{b=g.addParticle(l.x,l.y,l.mass,l.radius,l.style),b.xVel=l.xVel,b.yVel=l.yVel,b.cOR=l.cOR,q.stage.removeChild(f),
q.stage.removeChild(e),l.xVel=l.yVel=0,1!=d||p?c=0:(c=2,q.stage.removeChild(l.displayObj))}catch(h){n.text=h,n.x=q.width-n.getMeasuredWidth(),n.y=q.height/2,q.stage.addChild(n),r=m.global.errorTime,t=!0}break;case 2:l.displayObj.dispatchEvent("click"),2==a.button?g.removeSelected():(b=l,l=b.copy(),y=b.x,z=b.y,q.stage.addChild(l.displayObj),p||g.removeSelected(),c=0)}a.stopPropagation()});this.draw=function(a){this.hidden||(null!=l&&l.draw(l.x,l.y),t&&(r-=1E3/m.global.updateRate,0>=r&&(t=!1,this.stage.removeChild(n))),
this.stage.update())};this.beginAdd=function(f,g,h){this.show();this.init();l=new Particle(crossX,crossY,25,h,m);l.mass=f;l.cOR=g;e.x=a;e.y=b;this.stage.addChild(l.displayObj);s.text="Mode: Add";d=c=0};this.beginEdit=function(){this.show();this.init();s.text="Mode: Edit";c=2;d=1};this.end=function(){this.hide();this.stage.removeAllChildren();null!=l&&(l=null);d=-1;p=u=!1};this.getCurrentParticle=function(){return l};this.getMode=function(){return d}}Overlay.prototype=new Widget;function Simulation(k,g,m){Widget.call(this,k);this.engine=g;this.engine.width=this.width;this.engine.height=this.height;var h=-1;this.resize=function(c,d){this.engine.setBounds(c,d)};this.addParticle=function(c,d,a,b,f){c=new Particle(c,d,b,f,m);c.mass=a;var e=this.engine,g=this;c.addEventHandler("click",function(a){var b=e.getParticle(h);-1!=h&&(b.deselect(),g.onDeselect(b));for(var c=0;c<e.numOfParticles();c++)if(b=e.getParticle(c),b.displayObj==a.target){c!=h?(g.onSelect(b),h=c,b.selected=!0):
h=-1;break}});this.stage.addChild(c.displayObj);this.engine.addParticle(c);return c};this.onSelect=function(c){};this.onDeselect=function(c){};this.removeParticle=function(c){this.stage.removeChild(this.engine.getParticle(c).displayObj);this.engine.removeParticle(c)};this.loadParticles=function(c){this.restart();for(var d=0;d<c.length;d++){var a=c[d],b=this.addParticle(a.x,a.y,a.mass,a.radius,a.style);b.xVel=a.xVel;b.yVel=a.yVel;b.cOR=a.cOR}};this.saveParticles=function(c){for(var d=0;d<this.engine.numOfParticles();d++){var a=
this.engine.getParticle(d);c.push(a.copy())}};this.removeSelected=function(){-1!=h&&(this.removeParticle(h),h=-1)};this.getSelected=function(){var c=null;-1!=h&&(c=this.engine.getParticle(h));return c};this.getSelectedID=function(){return h};this.restart=function(){this.stage.removeAllChildren();h=-1;this.engine.reset()};this.draw=function(c){for(var d=0;d<this.engine.numOfParticles();d++){var a=this.engine.getParticle(d),b=a.x,f=a.y;m.global.enableInterpolation&&(f=a.y-a.lastY,b=a.lastX+c*(a.x-a.lastX),
f=a.lastY+c*f);a.draw(b,f)}this.stage.update()}}Simulation.prototype=new Widget;function Widget(k){this.hidden=!1;this.canvasName=k;this.canvas=$("#"+k);this.width=this.canvas.width();this.height=this.canvas.height();this.stage=new createjs.Stage(k);this.canvas.attr("width",this.width);this.canvas.attr("height",this.height);this.init=function(){};this.addEventListener=function(g,k){this.stage.addEventListener(g,k)};this.draw=function(g){};this.restart=function(){};this.stop=function(){};this.resume=function(){this.paused=!1};this.pause=function(){this.paused=!0};this.resize=
function(g,k){};this.show=function(){this.hidden=!1;this.canvas.fadeIn(200)};this.hide=function(){this.hidden=!0;this.canvas.fadeOut(200)}};
